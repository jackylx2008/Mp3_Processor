### **需求文档（2025-01-28 21:34）**

#### 1. **项目概述**

本项目旨在处理大容量 MP3 文件，提供以下功能：

- **切割 MP3 文件**：根据用户提供的时长或文件大小将 MP3 文件分割为多个部分。
- **添加封面**：为 MP3 文件添加图片封面。
- **增加 MP3 信息**：能够读取、修改或添加 MP3 的元数据，包括但不限于标题、艺术家、专辑、年份、曲风等。
- **异步处理**：对大容量 MP3 文件的处理（如切割、封面嵌入、元数据修改等）进行异步化处理，提高效率，减少阻塞。

#### 2. **功能需求**

##### 2.1 切割 MP3 文件

- **输入**：用户提供一个 MP3 文件和分割的参数（时间或文件大小）。
- **输出**：将 MP3 文件切割为若干个新的 MP3 文件，文件名应符合命名规则（如 `original_filename_part_1.mp3`）。

##### 2.2 添加封面

- **输入**：用户提供 MP3 文件和封面图片（JPEG 或 PNG 格式）。
- **输出**：将封面图片嵌入 MP3 文件中，保证 MP3 文件仍然能够正常播放，并且封面能够在 MP3 播放器中显示。

##### 2.3 增加 MP3 信息

- **输入**：用户提供 MP3 文件和元数据信息（如标题、艺术家、专辑、年份等）。
- **输出**：根据用户提供的信息修改 MP3 的 ID3 标签，增加或更新相关元数据。

##### 2.4 异步处理

- **需求**：
  - 对于长时间操作（如切割大容量文件或批量文件处理）进行异步化处理，使用异步框架（如 Python 的 `asyncio` 或 `concurrent.futures`）。
  - 支持后台任务的处理，可以在后台执行长时间操作而不会阻塞用户界面或主线程。
  - 提供任务进度反馈或通知机制，以便用户了解处理的进度。

#### 3. **技术要求**

- **编程语言**：Python 3.x
- **依赖库**：
  - `pydub`：处理音频文件的切割和转码。
  - `eyed3`：处理 MP3 元数据（ID3 标签）。
  - `Pillow`：处理封面图片。
  - `asyncio` 或 `concurrent.futures`：用于异步处理和并发任务。
- **操作系统**：支持 Linux、Windows、macOS。

#### 4. **用户界面需求**

本项目暂不涉及图形用户界面，所有操作将通过命令行进行，但会支持异步处理的任务进度反馈。

#### 5. **性能要求**

- 能够高效处理大容量的 MP3 文件（文件大小大于 1GB）。
- 分割和写入封面、修改元数据的操作应尽量保证高效性，避免长时间卡顿。
- 支持异步任务，能够在后台高效处理多个文件。

#### 6. **错误处理与日志**

- 提供详细的错误日志记录，帮助调试和排查问题。
- 在操作过程中如出现文件损坏或格式错误，提供用户友好的错误提示。
- 支持任务的异常捕获和错误回调。

#### 7. **进度和通知**

- 提供任务执行的进度反馈，尤其是对于大文件处理。
- 可以通过命令行输出进度条、百分比等信息，或者通过日志记录处理状态。
- 支持任务完成后的通知（例如通过邮件、系统通知等方式）。

---

### **项目目录结构（更新版）**

对于异步处理，我们可能需要对项目目录结构做一些微小调整，例如：

```
mp3_processor/
│
├── assets/                # 存放封面图片、其它资产文件
│   └── cover_images/      # 存放封面图片（JPEG/PNG）
│
├── logs/                  # 存放日志文件
│   └── mp3_processor.log
│
├── mp3_files/             # 存放待处理的MP3文件
│   └── input/             # 用户上传的原始MP3文件
│   └── output/            # 切割后的MP3文件
│
├── src/                   # 源代码
│   ├── __init__.py        # 初始化文件
│   ├── config_loader.py   # 读取配置文件的模块
│   ├── cover_handler.py   # 处理封面图片嵌入
│   ├── file_handler.py    # 用于处理文件（切割、读取封面等）
│   ├── logging_config.py  # 日志配置文件
│   ├── mp3_metadata.py    # 处理MP3的ID3标签、元数据
│   ├── async_tasks.py     # 异步任务管理模块，处理异步操作
│   └── utils.py           # 常用的辅助函数
│
├── tests/                 # 单元测试
│   ├── test_file_handler.py
│   ├── test_mp3_metadata.py
│   ├── test_cover_handler.py
│   ├── test_async_tasks.py
│   └── test_utils.py
│
├── .env                   # 环境变量文件，用于存储敏感信息
├── README.md              # 项目说明文件
├── config.json       # 配置文件
├── requirements.txt       # 项目依赖
└── run.py                 # 启动脚本，用于执行命令行操作
```

#### 说明

- **async_tasks.py**：新增的模块，负责异步任务的管理。可以使用 `asyncio` 或 `concurrent.futures` 来执行文件处理任务，提供任务的执行与管理功能。
- **test_async_tasks.py**：新增的测试模块，测试异步任务的执行和任务进度的正确性。

---
